# shellcheck shell=bash

export DEV_SHELL_PATHS_LST="${DEV_SHELL_PATHS_LST}"
export LST_DIR="${LST_DIR}"
export PREFIX="${PREFIX}"
export SHELL_DIR="${SHELL_DIR}"
export STATE_DIR="${STATE_DIR}"
export WATCH_FILES_LST="${WATCH_FILES_LST}"

export BUILD_AND_SYMLINK="${BUILD_AND_SYMLINK}"
export BUILD_LAZY_DERIVATIONS="${BUILD_LAZY_DERIVATIONS}"
export BUILD_SHELL="${BUILD_SHELL}"
export FIND_DEPENDENCY_GRAPH_EDGES="${FIND_DEPENDENCY_GRAPH_EDGES}"
export FIND_STALE_DEPENDENCY_GRAPH_NODES="${FIND_STALE_DEPENDENCY_GRAPH_NODES}"
export UPDATE_GENERATED_NIX="${UPDATE_GENERATED_NIX}"
export WATCH_FILES="${WATCH_FILES}"

BIN_NAMES_LST="${LST_DIR}"/bin-names.lst
CACHE_DIR="${STATE_DIR}"/cache
DEPENDENCY_GRAPH_EDGES_LST="${LST_DIR}"/dependency-graph-edges.lst
GENERATED_NIX=nix/generated.nix
MTIME_DIR="${STATE_DIR}"/mtime
STALE_GRAPH_NODES_LST="${LST_DIR}"/stale-graph-nodes.lst

PATH_PREFIX=../ \
	"${UPDATE_GENERATED_NIX}" \
	>"${GENERATED_NIX}"

"${FIND_DEPENDENCY_GRAPH_EDGES}" \
	>"${DEPENDENCY_GRAPH_EDGES_LST}"

{
	SHELL_DIR="${SHELL_DIR}" \
		"${BUILD_SHELL}"

	CACHE_DIR="${CACHE_DIR}" \
		PREFIX="${PREFIX}" \
		SHELL_DIR="${SHELL_DIR}" \
		"${BUILD_LAZY_DERIVATIONS}" \
		<"${BIN_NAMES_LST}"
} >"${DEV_SHELL_PATHS_LST}"

GENERATED_NIX="${GENERATED_NIX}" \
	"${WATCH_FILES}" \
	<"${DEPENDENCY_GRAPH_EDGES_LST}" \
	>"${WATCH_FILES_LST}"

GENERATED_NIX="${GENERATED_NIX}" \
	MTIME_DIR="${MTIME_DIR}" \
	PREFIX="${PREFIX}" \
	"${FIND_STALE_DEPENDENCY_GRAPH_NODES}" \
	<"${DEPENDENCY_GRAPH_EDGES_LST}" \
	>"${STALE_GRAPH_NODES_LST}"

if test "${EAGERLY_REBUILD:-}" = true; then
	CACHE_DIR="${CACHE_DIR}" \
		"${BUILD_AND_SYMLINK}" \
		<"${STALE_GRAPH_NODES_LST}"
else
	while read -r node; do
		rm "${CACHE_DIR}"/"${node}" >/dev/null 2>&1 || true
	done <"${STALE_GRAPH_NODES_LST}"
fi
